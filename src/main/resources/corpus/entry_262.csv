2017,A framework for Multi-A(rmed)/B(andit) Testing with Online FDR Control,We propose an alternative framework to existing setups for controlling false alarms when multiple A/B tests are run over time. This setup arises in many practical applications  e.g. when pharmaceutical companies test new treatment options against control pills for different diseases  or when internet companies test their default webpages versus various alternatives over time. Our framework proposes to replace a sequence of A/B tests by a sequence of best-arm MAB instances  which can be continuously monitored by the data scientist. When interleaving the MAB tests with an online false discovery rate (FDR) algorithm  we can obtain the best of both worlds: low sample complexity and any time online FDR control. Our main contributions are: (i) to propose reasonable definitions of a null hypothesis for MAB instances; (ii) to demonstrate how one can derive an always-valid sequential p-value that allows continuous monitoring of each MAB test; and (iii) to show that using rejection thresholds of online-FDR algorithms as the confidence levels for the MAB algorithms results in both sample-optimality  high power and low FDR at any point in time. We run extensive simulations to verify our claims  and also report results on real data collected from the New Yorker Cartoon Caption contest.,A framework for Multi-A(rmed)/B(andit) Testing

with Online FDR Control

Fanny Yang

Dept. of EECS  U.C. Berkeley
fanny-yang@berkeley.edu

Kevin Jamieson

Allen School of CSE  U. of Washington

jamieson@cs.washington.edu

Aaditya Ramdas

Dept. of EECS and Statistics  U.C. Berkeley

ramdas@berkeley.edu

Martin Wainwright

Dept. of EECS and Statistics  U.C. Berkeley

wainwrig@berkeley.edu

Abstract

We propose an alternative framework to existing setups for controlling false alarms
when multiple A/B tests are run over time. This setup arises in many practical
applications  e.g. when pharmaceutical companies test new treatment options
against control pills for different diseases  or when internet companies test their
default webpages versus various alternatives over time. Our framework proposes to
replace a sequence of A/B tests by a sequence of best-arm MAB instances  which
can be continuously monitored by the data scientist. When interleaving the MAB
tests with an online false discovery rate (FDR) algorithm  we can obtain the best of
both worlds: low sample complexity and any time online FDR control. Our main
contributions are: (i) to propose reasonable deï¬nitions of a null hypothesis for
MAB instances; (ii) to demonstrate how one can derive an always-valid sequential
p-value that allows continuous monitoring of each MAB test; and (iii) to show that
using rejection thresholds of online-FDR algorithms as the conï¬dence levels for
the MAB algorithms results in both sample-optimality  high power and low FDR
at any point in time. We run extensive simulations to verify our claims  and also
report results on real data collected from the New Yorker Cartoon Caption contest.

Introduction

1
Randomized trials are the default option to determine whether potential improvements of an alternative
method (e.g. website design for a tech company  or medication in clinical trials for pharmaceutical
companies) are signiï¬cant compared to a well-established default. In the applied domain  this is often
colloquially referred to as A/B testing or A/B/n testing for several alternatives. The standard practice
is to divert a small amount of the trafï¬c or patients to the alternative and control. If an alternative
appears to be signiï¬cantly better  it is implemented; otherwise  the default setting is maintained.
At ï¬rst glance  this procedure seems intuitive and simple. However  in cases where the aim is to
optimize over one particular metric  one can do better. In particular  this common tool suffers from
several downsides. (1) First  one may wish to allocate more trafï¬c to a better treatment if it is clearly
better. Yet typical A/B/n testing frameworks split the trafï¬c uniformly over alternatives. Adaptive
techniques should help to detect better alternatives faster. (2) Second  companies often desire to
continuously monitor an ongoing A/B test as they may adjust their termination criteria as time goes
by and possibly stop earlier or later than originally intended. However  this practice may result in
many more false alarms if not properly accounted for. This is one of the reasons for the lack of
reproducibility of scientiï¬c results  an issue recently receiving increased attention from the public
media. (3) Third  the lack of sufï¬cient evidence or an insigniï¬cant improvement of the metric may
make it undesirable from a practical or ï¬nancial perspective to replace the default. Therefore  when a

31st Conference on Neural Information Processing Systems (NIPS 2017)  Long Beach  CA  USA.

company runs hundreds to thousands of A/B tests within a year  ideally the number of statistically
insigniï¬cant changes that it made should be small relative to the total number of changes made. While
controlling the false alarm rate of each individual test does not achieve this type of false discovery
rate (FDR) control  there are known procedures in the multiple testing literature that are tailored to
this problem.
In this paper  we provide a novel framework that addresses the above shortcomings of A/B or A/B/n
testing. The ï¬rst concern is tackled by employing recent advances in adaptive sampling like the pure-
exploration multi-armed bandit (MAB) algorithm. For the second concern  we adopt the notion of
any-time p-values for guilt-free continuous monitoring. Finally  we handle the third issue using recent
results in online FDR control. Hence the combined framework can be described as doubly-sequential
(sequences of MAB tests  each of which is itself sequential). Although each of those problems
has been studied in hitherto disparate communities  how to leverage the best of all worlds  if at all
possible  has remained an open problem. The main contributions of this paper are in successfully
merging these ideas in a meta framework and presenting the conditions under which it can be shown
to yield near-optimal sample complexity and FDR control.
The remainder of this paper is organized as follows. In Section 2  we lay out the conceptual challenges
that we address in the paper  and describe a meta-algorithm that combines adaptive sampling strategies
with FDR control procedures. Section 3 is devoted to the description of a concrete procedure  along
with some theoretical guarantees on its properties. In Section 4  we discuss some results of our
extensive experiments on both simulated and real-world data sets available to us.
2 Formal experimental setup and a meta-algorithm
In this section provide a high-level overview of our proposed combined framework aimed at address-
ing the shortcomings mentioned in the introduction. A speciï¬c instantiation of this meta-algorithm
along with detailed theoretical guarantees are speciï¬ed in Section 3.
For concreteness  we refer to the system designer  whether a tech company or a pharmaceutical
company  as a (data) scientist. We assume that the scientist needs to possibly conduct an inï¬nite
number of experiments sequentially  indexed by j. Each experiment has one default setting  referred
to as the control  and K = K(j) alternative settings  called the treatments or alternatives. The
scientist must return one of the K + 1 options that is the â€œbestâ€ according to some predeï¬ned metric 
before the next experiment is started. Such a setup is a simple mathematical model both for clinical
trials run by pharmaceutical labs  and A/B/n testing used at scale by tech companies.
One full experiment consists of a sequence of steps. In each step  the scientist assigns a new person to
one of the K + 1 options and observes an outcome. In practice  the role of the scientist could be taken
by an adaptive algorithm  which determines the assignment at time step j by careful consideration
of all previous outcomes. Borrowing terminology from the multi-armed bandit (MAB) literature 
we refer to each of the K + 1 options as an arm  and each assignment to arm i is termed â€œpulling
arm iâ€. For concreteness  we assign the index 0 to the control arm and note that it is known to the
algorithm. Furthermore  we assume that the observable metric from each pull of arm i = 0  1  . . .   K
corresponds to an independent draw from an unknown probability distribution with expectation Âµi.
In the sequel we use Âµi(cid:63) := max
Âµi to denote the mean of the best arm. We refer the reader to
i=1 ... K
Table 1 in Appendix A for a glossary of the notation used throughout this paper.

2.1 Some desiderata and difï¬culties
Given the setup above  how can we mathematically describe the guarantees that the companies might
desire from an improved multiple-A/B/n testing framework? For which parts can we leverage known
results and what challenges remain?
For the purpose of addressing the ï¬rst question  let us adopt terminology from the hypothesis testing
literature and view each experiment as a test of a null hypothesis. Any claim that an alternative arm is
the best is called a discovery  and when such a claim is erroneous  it is called a false discovery. When
multiple hypotheses are to be tested  the scientist needs to deï¬ne the quantity it wants to control.
While we may desire that the probability of even a single false discovery is small  this is usually
far too stringent for a large and unknown number of tests and results in low power. For this reason 
[1] proposed that it may be more useful to control the expected ratio of false discoveries to the total
number of discoveries (called the False Discovery Rate  or FDR for short) or the ratio of expected
number of false discoveries to the expected number of total discoveries (called the modiï¬ed FDR

2

or mFDR for short). Over the past decades  the FDR and its variants like the mFDR have become
standard quantities for multiple testing applications. In the following  if not otherwise speciï¬ed  we
use the term FDR to denote both measures in order to simplify the presentation. In Section 3  we
show that both mFDR and FDR can be controlled for different choices of procedures.
2.1.1 Challenges in viewing an MAB instance as a hypothesis test
In our setup  we want to be able to control the FDR at any time in an online manner. Online FDR
procedures were ï¬rst introduced by Foster and Stine [2]  and have since been studied by other authors
(e.g.  [3  4]). They are based on comparing a valid p-value P j with carefully-chosen levels Î±j for
each hypothesis test1. We reject the null hypothesis  represented as Rj = 1  when P j â‰¤ Î±j and we
set Rj = 0 otherwise.
As mentioned  we want to use adaptive MAB algorithms to test each hypothesis  since they can ï¬nd a
best arm among K + 1 with near-optimal sample complexity. However the traditional MAB setup
does not account for the asymmetry between the arms as is the case in a testing setup  with one being
the default (control) and others being alternatives (treatments). This is the standard scenario in A/B/n
testing applications  as e.g. a company might prefer wrong claims that the control is the best (false
negative)  rather than wrong claims that an alternative is the best (false positive)  simply because new
system-wide adoption of selected alternatives might involve high costs. What would be a suitable
null hypothesis in this hybrid setting? For the sake of continuous monitoring  is it possible to deï¬ne
and compute always-valid p-values that are super-uniformly distributed under the null hypothesis
when computed at any time t?
In addition to asymmetry  the practical scientist might have a different incentive than the ideal outcome
for MAB algorithms as he/she might not want to ï¬nd the best alternative if it is not substantially
better than the control. Indeed  if the net gain is small  it might be offset by the cost of implementing
the change from the existing default choice. By similar reasoning  we may not require identifying
the single best arm if there is a set of arms with similar means all larger than the rest. We propose a
sensible null-hypothesis for each experiment which incorporates the approximation and minimum
improvement requirement as described above  and provide an always valid p-value which can be
easily calculated at each time step in the experiment. We show that a slight modiï¬cation of the usual
LUCB algorithm caters to this speciï¬c null-hypothesis while still maintaining near-optimal sample
complexity.

Figure 1: Diagram of our MAB-FDR meta algorithm. The green solid arrows symbolize interaction
between the MAB and FDR procedures via the FDR test levels Î±j and rejection indicator variables Rj.
Notice that the P j-values are now dependent as each Î±j depends on the past rejections R1  . . .   Rjâˆ’1.
The eyes represent possible continuous monitoring by the scientist.

2.1.2 Interaction between MAB and FDR
In order to take advantage of the sample efï¬ciency of best-arm bandit algorithms  it is crucial to set the
conï¬dence levels close to what is needed. Given a user-deï¬ned level Î±  at each hypothesis j  online

1A valid P j must be stochastically dominated by a uniform distribution on [0  1]  which we henceforth refer

to as super-uniformly distributed.

3

MAB-FDR meta algorithmğ›¼ğ›¼ğ‘—ğ‘—ğ‘…ğ‘…ğ‘—ğ‘—(ğ›¼ğ›¼ğ‘—ğ‘—)ExpjMABTestğ‘ğ‘ğ‘—ğ‘—<ğ›¼ğ›¼ğ‘—ğ‘—ğ‘ğ‘ğ‘—ğ‘—(ğ›¼ğ›¼ğ‘—ğ‘—)ğ›¼ğ›¼j+1ğ‘…ğ‘…j+1(ğ›¼ğ›¼j+1)Expj+1MABTestğ‘ğ‘j+1 <ğ›¼ğ›¼j+1ğ‘ğ‘j+1 (ğ›¼ğ›¼j+1)Online FDR procedureâ€¦â€¦desired FDR level ğ›¼ğ›¼FDR procedures automatically output the signiï¬cance level Î±j which are sufï¬cient to guarantee FDR
control  based on past decisions. Can we directly set the MAB conï¬dence levels to these output levels
Î±j? If we do  our p-values are not independent across different hypotheses anymore: P j directly
depends on the FDR levels Î±j and each Î±j in turn depends on past MAB rejections  thus on past
MAB p-values (see Figure 1). Does the new interaction compromise FDR guarantees?
Although known procedures as in [2  4] guarantee FDR control for independent p-values  this does
not hold for dependent p-values in general. Hence FDR control guarantees cannot simply be obtained
out of the box. A key insight that emerges from our analysis is that an appropriate bandit algorithm
actually shapes the p-value distribution under the null in a â€œgoodâ€ way that allows us to control FDR.
2.2 A meta-algorithm
Procedure 1 summarizes our doubly-sequential procedure  with a corresponding ï¬‚owchart in Figure 1.
We will prove theoretical guarantees after instantiating the separate modules. Note that our framework
allows the scientist to plug in their favorite best-arm MAB algorithm or online FDR procedure. The
choice for each of them determines which guarantees can be proven for the entire setup. Any
independent improvement in either of the two parts would immediately lead to an overall performance
boost of the overall framework.

Procedure 1 MAB-FDR Meta algorithm skeleton

1. The scientist sets a desired FDR control rate Î±.
2. For each j = 1  2  . . . :
â€¢ Experiment j receives a designated control arm and some number of alternative arms.
â€¢ An online-FDR procedure returns an Î±j that is some function of the past values {P (cid:96)}jâˆ’1
(cid:96)=1.
â€¢ An MAB procedure is executed with inputs (a) the control arm and K(j) alternative arms 
(b) conï¬dence level Î±j  maintains an always valid p-value for each t and if the procedure
self-terminates  returns a recommended arm.

â€¢ When the MAB procedure is terminated at time t by itself or the user  if the arm with the
t â‰¤ Î±j  then we return P j := P j
t  

highest empirical mean is not the control arm and P j
and the control arm is rejected in favor of this empirically best arm.

3 A concrete procedure with guarantees
We now take the high-level road map given in Procedure 1  and show that we can obtain a concrete 
practically implementable framework with FDR control and power guarantees. We ï¬rst discuss the
key modeling decisions we have to make in order to seamlessly embed MAB algorithms into an
online FDR framework. We then outline a modiï¬ed version of a commonly used best-arm algorithm 
before we ï¬nally prove FDR and power guarantees for the concrete combined procedure.
3.1 Deï¬ning null hypotheses and constructing p-values
Our ï¬rst task is to deï¬ne a null hypothesis for each experiment. As mentioned before  the choice of
the null is not immediately obvious  since we sample from multiple distributions adaptively instead
of independently. In particular  we will generally not have the same number of samples for all arms.
i=1  we propose that the null hypothesis for the
Given a default mean Âµ0 and alternatives means {Âµi}K
j-th experiment should be deï¬ned as

H j
0 : Âµ0 â‰¥ Âµi âˆ’ 

for all i = 1  . . .   K 

(1)
where we usually omit the index j for simplicity. It remains to deï¬ne an always valid p-value
(previously deï¬ned by Johari et al. [5]) for each experiment for the purpose of continuous monitoring.
It is deï¬ned as a stochastic process {Pt}âˆt=1 such that for all ï¬xed and random stopping times T  
under any distribution P0 over the arm rewards such that the null hypothesis is true  we have
(2)
When all arms are drawn independently an equal number of times  by linearity of expectation one can
regard the distance of each pair of samples as a random variable drawn i.i.d. from a distribution with
mean ËœÂµ := Âµ0 âˆ’ Âµi. We can then view the problem as testing the standard hypothesis H j
0 : ËœÂµ > âˆ’.
However  when the arms are pulled adaptively  a different solution needs to be foundâ€”indeed  in this

P0(PT â‰¤ Î±) â‰¤ Î±.

4

case  the sample means are not unbiased estimators of the true means  since the number of times an
arm was pulled now depends on the empirical means of all the arms.
Our strategy is to construct always valid p-values by using the fact that p-values can be obtained
by inverting conï¬dence intervals. To construct always-valid conï¬dence bounds  we resort to the
fundamental concept of the law of the iterated logarithm (LIL)  for which non-asymptotic versions
have been recently derived and used for both bandits and testing problems (see [6]  [7]).
To elaborate  deï¬ne the function

log( 1

Î´ ) + 3 log(log( 1
Î´ )) + 3
n

2 log(log(en))

Ï•n(Î´) =

If(cid:98)Âµi n is the empirical average of independent samples from a sub-Gaussian distribution  then it is
known (see  for instance  [8  Theorem 8]) that for all Î´ âˆˆ (0  1)  we have

.

(cid:110)P(cid:16) âˆ(cid:91)

(cid:17)
{(cid:98)Âµi n âˆ’ Âµi > Ï•n(Î´ âˆ§ 0.1)}

  P(cid:16) âˆ(cid:91)

{(cid:98)Âµi n âˆ’ Âµi < âˆ’Ï•n(Î´ âˆ§ 0.1)}

(4)

â‰¤ Î´ 

(cid:17)(cid:111)

(3)

max

n=1

(cid:115)

n=1

where Î´ âˆ§ 0.1 := min{Î´  0.1}.
We are now ready to propose single arm p-values of the form

(cid:110)
Î³ âˆˆ [0  1] | (cid:98)Âµi ni(t) âˆ’ Ï•ni(t)( Î³
(cid:110)
Î³ âˆˆ [0  1] | LCBi(t) â‰¤ UCB0(t) + 

(cid:111)

Pi t : = sup

= sup

2K ) â‰¤ (cid:98)Âµ0 n0(t) + Ï•n0(t)( Î³

2 ) + 

(cid:111)

(5)

Here we set Pi t = 1 if the supremum is taken over an empty set. Given these single arm p-values 
the always-valid p-value for the experiment is deï¬ned as

Pt := min
sâ‰¤t

min

i=1 ... K

Pi s.

(6)

i=0 1 ... K

MAB algorithms can identify i(cid:63) with probability at least 1âˆ’Î´ based on at most2(cid:80)

We claim that this procedure leads to an always valid p-value (with proof in Appendix C).
Proposition 1. The sequence {Pt}âˆt=1 deï¬ned via equation (6) is an always valid p-value.
3.2 Adaptive sampling for best-arm identiï¬cation
In the traditional A/B testing setting described in the introduction  samples are allocated uniformly
to the different alternatives. But by allowing adaptivity  decisions can be made with the same
statistical signiï¬cance using far fewer samples. Suppose moreover that there is a unique maximizer
Âµi  so that âˆ†i := Âµi(cid:63) âˆ’ Âµi > 0 for all i (cid:54)= i(cid:63). Then for any Î´ âˆˆ (0  1)  best-arm
i(cid:63) := arg max
log(1/Î´)
total samples (see the paper [9] for a brief survey and [10] for an application to clinical trials). In
contrast  if samples are allocated uniformly to the alternatives under the same conditions  then the
most natural procedures require K max
log(K/Î´) samples before returning i(cid:63) with probability
i(cid:54)=i(cid:63)
at least 1 âˆ’ Î´.
However  standard best-arm bandit algorithms do not incorporate asymmetry as induced by null-
hypotheses as in deï¬nition (1) by default. Furthermore  recall that a practical scientist might desire
the ability to incorporate approximation and a minimum improvement requirement. More precisely 
it is natural to consider the requirement that the returned arm ib satisï¬es the bounds Âµib â‰¥ Âµ0 + 
and Âµib â‰¥ Âµi(cid:63) âˆ’  for some  > 0. In Algorithm 1 we present a modiï¬ed MAB algorithm based on
the common LUCB algorithm (see [11  12]) which incorporates the above desiderata. We provide a
visualization of how  affects the usual stopping condition in Figure 4 in Appendix A.1.
The following proposition applies to Algorithm 1 run with a control arm indexed by i = 0 with mean
Âµ0 and alternative arms indexed by i = 1  . . .   K with means Âµi  respectively. Let ib denote the
random arm returned by the algorithm assuming that it exits  and deï¬ne the set
and Âµi(cid:63) > Âµ0 + }.

S (cid:63) := {i(cid:63) (cid:54)= 0 | Âµi(cid:63) â‰¥ max

Âµi âˆ’ 

âˆ†âˆ’2

i

âˆ†âˆ’2

i

i=1 ... K

i(cid:54)=i(cid:63)

(7)

2Here we have ignored some doubly-logarithmic factors.

5

(cid:80)ni(t)

Algorithm 1 Best-arm identiï¬cation with a control arm for conï¬dence Î´ and precision  â‰¥ 0
i let(cid:98)Âµi(t) = 1
For all t let ni(t) be the number of times arm i has been pulled up to time t. In addition  for each arm
UCBi(t) :=(cid:98)Âµi ni(t) + Ï•ni(t)( Î´

LCBi(t) :=(cid:98)Âµi ni(t) âˆ’ Ï•ni(t)( Î´

Ï„ =1 ri(Ï„ )  deï¬ne

2K )

and

2 ).

ni(t)

1. Set t = 1 and sample every arm once.
2. Repeat: Compute ht = arg max

i=0 1 ... K(cid:98)Âµi(t)  and (cid:96)t = arg

max

UCBi(t)

i=0 1 ... K i(cid:54)=ht
(a) If LCB0(t) > UCBi(t) âˆ’   for all i (cid:54)= 0  then output 0 and terminate.

Else if LCBht(t) > UCB(cid:96)t(t) âˆ’  and LCBht(t) > UCB0(t) +   then output ht and
terminate.
(b) If  > 0  let ut = arg maxi(cid:54)=0 UCBi(t) and pull all distinct arms in {0  ut  ht  (cid:96)t} once.

If  = 0  pull arms ht and (cid:96)t and set t = t + 1.

Note that the mean associated with any index i(cid:63) âˆˆ S (cid:63)  assuming that the set is non-empty  is
guaranteed to be -superior to the control mean  and at most -inferior to the maximum mean over all
arms.
Proposition 2. The algorithm 1 terminates in ï¬nite time with probability one. Furthermore  suppose
that the samples from each arm are independent and sub-Gaussian with scale 1. Then for any
Î´ âˆˆ (0  1) and  â‰¥ 0  Algorithm 1 has the following guarantees:
(cid:16)(cid:80)K
i=0(cid:101)âˆ†âˆ’2
log(K log((cid:101)âˆ†âˆ’2
(a) Suppose that Âµ0 > max
i=1 ... K
(cid:101)âˆ†0 = (Âµ0 + ) âˆ’ max
(cid:101)âˆ†i = (Âµ0 + ) âˆ’ Âµi.
(cid:17)

Âµi âˆ’ . Then with probability at least 1 âˆ’ Î´  the algorithm exits with
time steps with effective gaps

(b) Otherwise  suppose that the set S (cid:63) as deï¬ned in equation (7) is non-empty. Then with probability

at least 1 âˆ’ Î´  the algorithm exits with ib âˆˆ S (cid:63) after taking at most
time steps with effective gaps
O

ib = 0 after taking at most O

(cid:16)(cid:80)K
i=0(cid:101)âˆ†âˆ’2

Âµj and

j=1 ... K

(cid:17)

)/Î´)

)/Î´)

i

i

i

i

log(K log((cid:101)âˆ†âˆ’2
(cid:26)
(cid:101)âˆ†0 = min
(cid:26)
(cid:101)âˆ†i = max

(cid:26)

max

j=1 ... K

Âµj âˆ’ (Âµ0 + )  max{âˆ†0  }

and

âˆ†i  min

max

j=1 ... K

Âµj âˆ’ (Âµ0 + )  

.

(cid:27)
(cid:27)(cid:27)

See Appendix D for the proof of this claim. Part (a) of Proposition 2 guarantees that when no
alternative arm is -superior to the control arm (i.e. under the null hypothesis)  the algorithm stops
and returns the control arm with probability at least 1 âˆ’ Î´. Part (b) guarantees that if there is in fact at
least one alternative that is -superior to the control arm (i.e. under the alternative)  then the algorithm
will ï¬nd at least one of them that is at most -inferior to the best of all possible arms.
As our algorithm is a slight modiï¬cation of the LUCB algorithm  the results of [11  12] pro-
vide insight into the number of samples taken before the algorithm terminates.
Indeed  when
 = 0 and i(cid:63) = arg maxi=0 1 ... K Âµi is a unique maximizer  the nearly optimal sample complex-
ity result of [12] implies that the algorithm terminates under settings (a) and (b) after at most
)/Î´) samples are taken (ignoring con-
maxj(cid:54)=i(cid:63) âˆ†âˆ’2
log(K log(âˆ†âˆ’2
stants)  where âˆ†i = Âµi(cid:63) âˆ’ Âµi.
In our development to follow  we now bring back the index for experiment j  in particular using P j
to denote the quantity P j
T at any stopping time T . Here the stopping time can either be deï¬ned by the
scientist  or in an algorithmic manner.

j )/Î´) +(cid:80)

log(log(âˆ†âˆ’2

âˆ†âˆ’2

i(cid:54)=i(cid:63)

j

i

i

6

3.3 Best-arm MAB interacting with online FDR
After having established null hypotheses and p-values in the context of best-arm MAB algorithms  we
are now ready to embed them into an online FDR procedure. In the following  we consider p-values
for the j-th experiment P j := P j
which is just the p-value as deï¬ned in equation (6) at the stopping
Tj
time Tj  which depends on Î±j.
We denote the set of true null and false null hypotheses up to experiment J as H0(J) and H1(J)
respectively  where we drop the argument whenever itâ€™s clear from the context. The variable
P jâ‰¤Î±j indicates whether a the null hypothesis of experiment j has been rejected  where
Rj = 1
Rj = 1 denotes a claimed discovery that an alternative was better than the control. The false
discovery rate (FDR) and modiï¬ed FDR up to experiment J are then deï¬ned as

FDR(J) := E

and

mFDR(J) :=

.

(8)

E(cid:80)
E(cid:80)J

jâˆˆH0 Rj
i=1 Ri + 1

(cid:80)
(cid:80)J

jâˆˆH0 Rj
i=1 Ri âˆ¨ 1

(cid:80)J

j=1

7

Here the expectations are taken with respect to distributions of the arm pulls and the respective
sampling algorithm. In general  it is not true that control of one quantity implies control of the other.
Nevertheless  in the long run (when the law of large numbers is a good approximation)  one does not
expect a major difference between the two quantities in practice.
The set of true nulls H0 thus includes all experiments where H j
0 is true  and the FDR and mFDR are
well-deï¬ned for any number of experiments J  since we often desire to control FDR(J) or mFDR(J)
for all J âˆˆ N. In order to measure power  we deï¬ne the -best-arm discovery rate as

BDR(J) :=

jâˆˆH1 Rj 1Âµibâ‰¥Âµi(cid:63)âˆ’1Âµibâ‰¥Âµ0+

(9)

E(cid:80)

|H1(J)|

We provide a concrete procedure 2 for our doubly sequential framework  where we use a particular
online FDR algorithm due to Javanmard and Montanari [4] known as LORD; the reader should note
that other online FDR procedure could be used to obtain essentially the same set of guarantees. Given
a desired level Î±  the LORD procedure starts off with an initial â€œÎ±-wealthâ€ of W (0) < Î±. Based on
a iniï¬nite sequence {Î³i}âˆi=1 that sums to one  and the time of the most recent discovery Ï„j  it uses up
a fraction Î³jâˆ’Ï„j of the remaining Î±-wealth to test. Whenever there is a rejection  we increase the
Î±-wealth by Î± âˆ’ W (0). A feasible choice for a stopping time in practice is Tj := min{T (Î±j)  TS} 
where TS is a maximal number of samples the scientist wants to pull and T (Î±j) is the stopping time
of the best-arm MAB algorithm run at conï¬dence Î±j.

Procedure 2 MAB-LORD: best-arm identiï¬cation with online FDR control

1. Initialize W (0) < Î±  set Ï„0 = 0  and choose a sequence {Î³i} s.t.(cid:80)âˆi=1 Î³i = 1

W (j + 1) = W (j) âˆ’ Î±j + Rj(Î± âˆ’ W (0))

2. At each step j  compute Î±j = Î³jâˆ’Ï„j W (Ï„j) and
3. Output Î±j and run Algorithm 1 using Î±j-conï¬dence and stop at a stopping time Tj.
4. Algorithm 1 returns P j and we reject the null hypothesis if P j â‰¤ Î±j.
5. Set Rj = 1

P jâ‰¤Î±j   Ï„j = Ï„jâˆ’1 âˆ¨ jRj  update j = j + 1 and go back to step 2.

The following theorem provides guarantees on mFDR and power for the MAB-LORD procedure.
Theorem 1 (Online mFDR control for MAB-LORD).
(a) Procedure 2 achieves mFDR control at level Î± for stopping times Tj = min{T (Î±j)  TS}.
(b) Furthermore  if we set TS = âˆ  Procedure 2 satisï¬es

BDR(J) â‰¥

1jâˆˆH1 (1 âˆ’ Î±j)
|H1(J)|

.

(10)

See Appendix E for the proof of this claim. Note that by the arguments in the proof of Theorem 1 
mFDR control itself is actually guaranteed for any generalized Î±-investing procedure [3] combined
with any best-arm MAB algorithm. In fact we could use any adaptive stopping time Tj which depend
on the history only via the rejections R1  . . .   Rjâˆ’1. Furthermore  using a modiï¬ed LORD proposed

by Javanmard and Montanari [13]  we can also guarantee FDR controlâ€“ a result we moved to the
Appendix F due to space constraints. It is noteworthy that small values of Î± do not only guarantee
smaller FDR error but also higher BDR. However  there is no free lunch â€” a smaller Î± implies a
smaller Î±j at each experiment  resulting in a larger required number of pulls for the the best-arm
MAB algorithm.
4 Experimental results
In the following  we brieï¬‚y describe some results of our experiments3 on both simulated and real-
world data sets  which illustrate that  apart from FDR control  MAB-FDR (used interchangeably with
MAB-LORD here) is highly advantageous in terms of sample complexity and power compared to a
straightforward embedding of A/B testing in online FDR procedures. Unless otherwise noted  we set
 = 0 in all of our simulations to focus on the main ideas and keep the discussion concise.
Competing procedures There are two natural frameworks to compare against MAB-FDR. The
ï¬rst  called AB-FDR or AB-LORD  swaps the MAB part for an A/B (i.e. A/B/n) test (uniformly
sampling all alternatives until termination). The second comparator exchanges the online FDR
control for independent testing at Î± for all hypotheses â€“ we call this MAB-IND. Formally  AB-FDR
swaps step 3 in Procedure 2 with â€œOutput Î±j and uniformly sample each arm until stopping time Tj.â€
while MAB-IND swaps step 4 in Procedure 2 with â€œThe algorithm returns P j and we reject the null
hypothesis if P j â‰¤ Î±.â€. In order to compare the performances of these procedures  we ran three sets
of simulations using Procedure 2 with  = 0 and Î³j = 0.07 log(jâˆ¨2)
Our experiments are run on artiï¬cial data with Gaussian/Bernoulli draws and real-world Bernoulli
draws from the New Yorker Cartoon Caption Contest. Recall that the sample complexity of the
best-arm MAB algorithm is determined by the gaps âˆ†j = Âµi(cid:63) âˆ’ Âµj. One of the main relevant
differences to consider between an experiment of artiï¬cial or real-world nature is thus the distribution
of the means Âµi for i = 1  . . .   K. The artiï¬cial data simulations are run with a ï¬xed gap âˆ† := âˆ†2
while the means of the other arms are set uniformly in [0  Âµi(cid:63) âˆ’ âˆ†]. For our real-world simulations 
we use empirical means computed from the cartoon caption contest (see details in Appendix B.1.1).
In addition  the contests actually follow a natural chronological order  which makes this dataset highly
relevant to our purposes. In all simulations  60% of all the hypotheses are true nulls  and their indices
are chosen uniformly. Due to space constraints  the experimental results for artiï¬cial and real-world
Bernoulli draws are deferred to Appendix B.

log j as in [4].
âˆš

je

(a)

(b)

Figure 2: (a) Power vs. truncation time TS (per hypothesis) for 50 arms and (b) Sample complexity
vs. # arms for truncation time TS = 300 for Gaussian draws with ï¬xed Âµi(cid:63) = 8  âˆ† = 3 over 500
hypotheses with 200 non-nulls  averaged over 100 runs and Î± = 0.1.
Power and sample complexity In this section we include ï¬gures on artiï¬cial Gaussian trials which
conï¬rm that the total number of necessary pulls to determine signiï¬cance is much smaller for MAB-
FDR than for AB-FDR. In Fig. 2 (a) we ï¬x the number of arms and plot the BDR with  = 0 (BDR
for short) for both procedures over different choices of truncation times TS. Low BDR indicates that
the algorithm often reaches truncation time before it could stop. For Fig. 2 (b) we ï¬x TS and show
how the sample complexity varies with the number of arms.

3The code for

https://github.com/fanny-yang/MABFDR

reproducing all experiments and plots in this paper

is publicly available at

8

100200300400500600700800Truncation time TS0.00.20.40.60.81.0BDRMAB-LORDAB-LORD20406080100120Number of arms020406080100120140160Total number of samples /1000MAB-LORDAB-LORDObserve in Fig. 2 (a) that the power at any given truncation time is much higher for MAB-FDR than
AB-FDR. This is because the best-arm MAB is more likely to satisfy the stopping criterion before
any given truncation time than the uniform sampling algorithm. Fig. 2(b) qualitatively shows how
the total number of necessary arm pulls for AB-FDR increases much faster with the number of arms
than for MAB-FDR before it plateaus due to the truncation. Recall that whenever the best-arm MAB
stops before the truncation time in each hypothesis  the stopping criterion is met  i.e. the best arm is
identiï¬ed with probability at least 1 âˆ’ Î±j  so that the power is bound to be close to one whenever
Tj = T (Î±j).
mFDR control For Fig. 3  we again consider Gaussian draws as in Fig. 2. This time however  for
each true null hypothesis we skip the bandit experiment and directly draw P j âˆ¼ [0  1] to compare
with the signiï¬cance levels Î±j from our online FDR procedure 2 (see App. B.2 for motivation of this
setting). By Theorem 1  mFDR should still be controlled as it only requires the p-values to be super-
jâˆˆH0J Rj
uniform. In Fig. 3(a) we plot the instantaneous false discovery proportion FDP(J) =
j=1 Rj
over the hypothesis index for different runs with the same settings. Apart from initial ï¬‚uctuations due
to the relatively small denominator  observe how the guarantee for the FDR(J) = E FDP(J) with
the red line showing its empirical value  transfers to the control of each individual run (blue lines).

(cid:80)
(cid:80)T

(a)

(b)

Ï€2j2 such that(cid:80)âˆj=1 Î±j â‰¤ Î±

Figure 3: (a) Single runs of MAB-LORD (blue) and their average (red) with uniformly drawn p-values
for null hypotheses and Gaussian draws as in Figure 2. (b) mFDR over different proportions of
non-nulls Ï€1  with same settings  averaged over 80 runs.
In Figure 3 (b)  we compare the mFDR of MAB-FDR against MAB-IND and a Bonferroni type
correction. The latter uses a simple union bound and chooses Î±j = 6Î±
and thus trivially allows for any time FWER  implying FDR control. As expected  Bonferroni is too
conservative and barely makes any rejections whereas the naive MAB-IND approach does not control
FDR. LORD avoids both extremes and controls FDR while having reasonable power.
5 Discussion
The recent focus in popular media about the lack of reproducibility of scientiï¬c results erodes the
publicâ€™s conï¬dence in published scientiï¬c research. To maintain credibility of claimed discoveries 
simply decreasing the statistical signiï¬cance levels Î± of each individual experimental work (e.g. 
reject at level 0.001 rather than 0.05) would drastically hurt power. A common approach is instead
to control the ratio of false discoveries to claimed discoveries at some desired value over many
sequential experiments  requiring the statistical signiï¬cances Î±j to change from experiment to
experiment. Unlike earlier works on online FDR control  our framework synchronously interacts
with adaptive sampling methods like MABs to make the overall sampling procedure per experiment
much more efï¬cient than uniform sampling. To the best of our knowledge  it is the ï¬rst work that
successfully combines the beneï¬ts of adaptive sampling and FDR control. It is worthwhile to note that
any improvement  theoretical or practical  to either online FDR algorithms or best-arm identiï¬cation
in MAB  immediately results in a corresponding improvement for our MAB-FDR framework.
More general notions of FDR with corresponding online procedures have recently been developed by
Ramdas et al [14]. In particular  they incorporate the notion of memory and a priori importance of
each hypothesis. This could prove to be a valuable extension for our setting  especially in cases when
only the percentage of wrong rejections in the recent past matters. It would be useful to establish
FDR control for these generalized notions of FDR as well.

9

0.10.30.50.70.9Proportion of alternatives Ï€10.00.10.20.30.40.5mFDRMAB-LORDMAB-INDMAB-Bonf.Acknowledgements

This work was partially supported by Ofï¬ce of Naval Research MURI grant DOD-002888  Air Force
Ofï¬ce of Scientiï¬c Research Grant AFOSR-FA9550-14-1-001  and National Science Foundation
Grants CIF-31712-23800 and DMS-1309356.

References
[1] Y. Benjamini and Y. Hochberg  â€œControlling the false discovery rate: a practical and powerful
approach to multiple testing â€ Journal of the Royal Statistical Society. Series B (Methodological) 
pp. 289â€“300  1995.

[2] D. P. Foster and R. A. Stine  â€œÎ±-investing: a procedure for sequential control of expected false
discoveries â€ Journal of the Royal Statistical Society: Series B (Statistical Methodology)  vol. 70 
no. 2  pp. 429â€“444  2008.

[3] E. Aharoni and S. Rosset  â€œGeneralized Î±-investing: deï¬nitions  optimality results and ap-
plication to public databases â€ Journal of the Royal Statistical Society: Series B (Statistical
Methodology)  vol. 76  no. 4  pp. 771â€“794  2014.

[4] A. Javanmard and A. Montanari  â€œOnline rules for control of false discovery rate and false

discovery exceedance â€ The Annals of Statistics  2017.

[5] R. Johari  L. Pekelis  and D. J. Walsh  â€œAlways valid inference: Bringing sequential analysis to

A/B testing â€ arXiv preprint arXiv:1512.04922  2015.

[6] K. G. Jamieson  M. Malloy  R. D. Nowak  and S. Bubeck  â€œlilâ€™ucb: An optimal exploration

algorithm for multi-armed bandits â€ in COLT  vol. 35  2014  pp. 423â€“439.

[7] A. Balsubramani and A. Ramdas  â€œSequential nonparametric testing with the law of the iter-
ated logarithm â€ in Proceedings of the Thirty-Second Conference on Uncertainty in Artiï¬cial
Intelligence. AUAI Press  2016  pp. 42â€“51.

[8] E. Kaufmann  O. CappÃ©  and A. Garivier  â€œOn the complexity of best arm identiï¬cation in

multi-armed bandit models â€ The Journal of Machine Learning Research  2015.

[9] K. Jamieson and R. Nowak  â€œBest-arm identiï¬cation algorithms for multi-armed bandits in
the ï¬xed conï¬dence setting â€ in Information Sciences and Systems (CISS)  2014 48th Annual
Conference on.

IEEE  2014  pp. 1â€“6.

[10] S. S. Villar  J. Bowden  and J. Wason  â€œMulti-armed bandit models for the optimal design of
clinical trials: beneï¬ts and challenges â€ Statistical science: a review journal of the Institute of
Mathematical Statistics  vol. 30  no. 2  p. 199  2015.

[11] S. Kalyanakrishnan  A. Tewari  P. Auer  and P. Stone  â€œPac subset selection in stochastic multi-
armed bandits â€ in Proceedings of the 29th International Conference on Machine Learning
(ICML-12)  2012  pp. 655â€“662.

[12] M. Simchowitz  K. Jamieson  and B. Recht  â€œThe simulator: Understanding adaptive sampling

in the moderate-conï¬dence regime â€ arXiv preprint arXiv:1702.05186  2017.

[13] A. Javanmard and A. Montanari  â€œOn online control of false discovery rate â€ arXiv preprint

arXiv:1502.06197  2015.

[14] A. Ramdas  F. Yang  M. J. Wainwright  and M. I. Jordan  â€œOnline control of the false discovery
rate with decaying memory â€ in Advances in Neural Information Processing Systems (NIPS)
2017  arXiv preprint arXiv:1710.00499  2017.

10

,Fanny Yang
Aaditya Ramdas
Kevin Jamieson
Martin Wainwright