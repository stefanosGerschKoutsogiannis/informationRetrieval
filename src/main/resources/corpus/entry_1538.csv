2018,Discretely Relaxing Continuous Variables for tractable Variational Inference,We explore a new research direction in Bayesian variational inference with discrete latent variable priors where we exploit Kronecker matrix algebra for efficient and exact computations of the evidence lower bound (ELBO). The proposed "DIRECT" approach has several advantages over its predecessors; (i) it can exactly compute ELBO gradients (i.e. unbiased  zero-variance gradient estimates)  eliminating the need for high-variance stochastic gradient estimators and enabling the use of quasi-Newton optimization methods; (ii) its training complexity is independent of the number of training points  permitting inference on large datasets; and (iii) its posterior samples consist of sparse and low-precision quantized integers which permit fast inference on hardware limited devices. In addition  our DIRECT models can exactly compute statistical moments of the parameterized predictive posterior without relying on Monte Carlo sampling. The DIRECT approach is not practical for all likelihoods  however  we identify a popular model structure which is practical  and demonstrate accurate inference using latent variables discretized as extremely low-precision 4-bit quantized integers. While the ELBO computations considered in the numerical studies require over 10^2352 log-likelihood evaluations  we train on datasets with over two-million points in just seconds.,Discretely Relaxing Continuous Variables

for tractable Variational Inference

Trefor W. Evans

University of Toronto

Prasanth B. Nair

University of Toronto

trefor.evans@mail.utoronto.ca

pbn@utias.utoronto.ca

Abstract

We explore a new research direction in Bayesian variational inference with discrete
latent variable priors where we exploit Kronecker matrix algebra for efÔ¨Åcient and
exact computations of the evidence lower bound (ELBO). The proposed "DIRECT"
approach has several advantages over its predecessors; (i) it can exactly compute
ELBO gradients (i.e. unbiased  zero-variance gradient estimates)  eliminating
the need for high-variance stochastic gradient estimators and enabling the use of
quasi-Newton optimization methods; (ii) its training complexity is independent of
the number of training points  permitting inference on large datasets; and (iii) its
posterior samples consist of sparse and low-precision quantized integers which
permit fast inference on hardware limited devices.
In addition  our DIRECT
models can exactly compute statistical moments of the parameterized predictive
posterior without relying on Monte Carlo sampling. The DIRECT approach is not
practical for all likelihoods  however  we identify a popular model structure which
is practical  and demonstrate accurate inference using latent variables discretized as
extremely low-precision 4-bit quantized integers. While the ELBO computations
considered in the numerical studies require over 102352 log-likelihood evaluations 
we train on datasets with over two-million points in just seconds.

1

Introduction

Hardware restrictions posed by mobile devices make Bayesian inference particularly ill-suited for
on-board machine learning. This is unfortunate since the safety afforded by Bayesian statistics is
extremely valuable in many prominent mobile applications. For example  the cost of erroneous
decisions are very high in autonomous driving or mobile robotic control. The robustness and
uncertainty quantiÔ¨Åcation provided by Bayesian inference is therefore extremely valuable for these
applications provided inference can be performed on-board in real-time [1  2].
Outside of mobile applications  resource efÔ¨Åciency is still an important concern. For example 
deployed models making billions of predictions per day can incur substantial energy costs  making
energy efÔ¨Åciency an important consideration in modern machine learning architectures [3].
We approach the problem of efÔ¨Åcient Bayesian inference by considering discrete latent variable
models such that posterior samples of the variables will be quantized and sparse  leading to efÔ¨Åcient
inference computations with respect to energy  memory and computational requirements. Training a
model with a discrete prior is typically very slow and expensive  requiring the use of high variance
Monte Carlo gradient estimators to learn the variational distribution. The main contribution of this
work is the development of a method to rapidly learn the variational distribution for such a model
without the use of any stochastic estimators; the objective function will be computed exactly at
each iteration. To our knowledge  such an approach has not been taken for variational inference of
large-scale probabilistic models.

32nd Conference on Neural Information Processing Systems (NeurIPS 2018)  Montr√©al  Canada.

In this paper  we compare our work not only to competing stochastic variational inference (SVI)
methods for discrete latent variables  but also to the more general SVI methods for continuous latent
variables. We make this comparison with continuous variables by discretely relaxing continuous priors
using a discrete prior with a Ô¨Ånite support set that contains much of the structure and information as its
continuous analogue. Using this discretized prior we show that we can make use of Kronecker matrix
algebra for efÔ¨Åcient and exact ELBO computations. We will call our technique DIRECT (DIscrete
RElaxation of ConTinous variables). We summarize our main contributions below:
‚Ä¢ We efÔ¨Åciently and exactly compute the ELBO using a discrete prior even when this computation
requires more likelihood evaluations than the number of atoms in the known universe. This
achieves unbiased  zero-variance gradients which we show outperforms competing Monte Carlo
sampling alternatives that give high-variance gradient estimates while learning.
‚Ä¢ Complexity of our ELBO computations are independent of the quantity of training data using the
‚Ä¢ At inference time  we can exactly compute the statistical moments of the parameterized predictive
‚Ä¢ Using a discrete prior  our models admit sparse posterior samples that can be represented as
quantized integer values to enable efÔ¨Åcient inference  particularly on hardware limited devices.
‚Ä¢ We present the DIRECT approach for generalized linear models and deep Bayesian neural networks
‚Ä¢ Our empirical studies demonstrate superior performance relative to competing SVI methods on

posterior distribution  unlike competing techniques which rely on Monte Carlo sampling.

for regression  and discuss approximations that allow extensions to many other models.

DIRECT method  making the proposed approach amenable to big data applications.

problems with as many as 2 million training points.

The paper will proceed as follows; section 2 contains a background on variational inference and poses
the learning problem to be addressed while section 3 outlines the central ideas of the DIRECT method 
demonstrating the approach on several popular probabilistic models. Section 4 discusses limitations
of the proposed approach and outlines some work-arounds  for instance  we discuss how to go beyond
mean-Ô¨Åeld variational inference. We empirically demonstrate our approaches in section 5  and
conclude in section 6. Our full code is available at https://github.com/treforevans/direct.

2 Variational Inference Background

We begin with a review of variational inference  a method for approximating probability densities in
Bayesian statistics [4‚Äì9]. We introduce a regression problem for motivation; given X P Rnd  y P
Rn  a d-dimensional dataset of size n  we wish to evaluate y at an untried point x by constructing
a statistical model that depends on the b latent variables in the vector w P Rb. After specifying a
prior over the latent variables  Prpwq  and selecting a probabilistic model structure that admits the
likelihood Prpy|wq  we may proceed with Bayesian inference to determine the posterior Prpw|yq
which generally requires analytically intractable computations.
Variational inference turns the task of computing a posterior into an optimization problem. By
introducing a family of probability distributions qŒ∏pwq parameterized by Œ∏  we minimize the Kullback-
Leibler divergence to the exact posterior [9]. This equates to maximization of the evidence lower
bound (ELBO) which we can write as follows for a continuous or discrete prior  respectively

Prior

ELBO

ELBOpŒ∏q ¬ª qŒ∏pwq log Prpy|wq  log Prpwq  log qŒ∏pwq	dw 
ELBOpŒ∏q  qT log (cid:96)  log p  log q	 

(1)

(2)

i1  log p  tlog Prpwiqum

where log (cid:96)  tlog Prpy|wiqum
W P Rbm is the entire support set of the discrete prior.
It is immediately evident that computing the ELBO is challenging when b is large  since in the
continuous case eq. (1) is a b-dimensional integral  and in the discrete case the size of the sum in eq. (2)
generally increases exponentially with respect to b. Typically  the ELBO is not explicitly computed
and instead  a Monte Carlo estimate of the gradient of the ELBO with respect to the variational

i1  q  tqŒ∏pwiqum

i1  and twium

i1 

2

parameters Œ∏ is found  allowing stochastic gradient descent to be performed. We will outline some
existing techniques to estimate ELBO gradients with respect to the variational parameters  Œ∏.
For continuous priors  the reparameterization trick [10] can be used to perform variational inference.
The technique uses Monte Carlo estimates of the gradient of the evidence lower bound (ELBO) which
is maximized during the training procedure. While this approach has been employed successfully
for many large-scale models  we Ô¨Ånd that discretely relaxing continuous latent variable priors can
improve training and inference performance when using our proposed DIRECT technique which
computes the ELBO (and its gradients) exactly.
When the latent variable priors are discrete  reparameterization cannot be applied  however  the
REINFORCE [11] estimator may be used to provide an unbiased estimate of the ELBO during
training (alternatively called the score function estimator [12]  or likelihood ratio estimator [13]).
Empirically  the REINFORCE gradient estimator is found to give a high-variance when compared
with reparameterization  leading to a slow learning process. Unsurprisingly  we Ô¨Ånd that our proposed
DIRECT technique trains signiÔ¨Åcantly faster than a model trained using a REINFORCE estimator.
Recent work in variational inference with discrete latent variables has largely focused on continuous
relaxations of discrete variables such that reparameterization can be applied to reduce gradient
variance compared to REINFORCE. One example is CONCRETE [14  15] and its extensions [16  17].
We consider an opposing direction by identifying how the ELBO (eq. (2)) can be computed exactly
for a class of discretely relaxed probabilistic models such that the discrete latent variable model can be
trained more easily then its continuous counterpart. We outline this approach in the following section.

3 DIRECT: EfÔ¨Åcient ELBO Computations with Kronecker Matrix Algebra

We outline the central ideas of the DIRECT method and illustrate its application on several proba-
bilistic models. The DIRECT method allows us to efÔ¨Åciently and exactly compute the ELBO which
has several advantages over existing SVI techniques for discrete latent variable models such as  zero-
variance gradient estimates  the ability to use a super-linearly convergent quasi-Newton optimizer
(since our objective is deterministic)  and the per-iteration complexity is independent of training
set size. We will also discuss advantages at inference time such as the ability to exactly compute
predictive posterior statistical moments  and to exploit sparse and low-precision posterior samples.
To begin  we consider a discrete prior over our latent variables whose support set W forms a Cartesian
tensor product grid as most discrete priors do (e.g. any prior that factorizes between variables) so that
we can write

W 

¬Ñm b    b 1T
1 b 1T
swT
¬Ñm
1T
2 b    b 1T
¬Ñm b swT
¬Ñm
...
...
...
1T
¬Ñm b 1T
¬Ñm b    b swT

...

b

 



(3)

where 1¬Ñm P R¬Ñm denotes a vector of ones  swi P R¬Ñm contains the sm discrete values that the ith
latent variable wi can take1  m  smb  and b denotes the Kronecker product [18]. Since the number
q  log p  log (cid:96)  and log q can be written as a sum of Kronecker product vectors (i.e.¬∞i√Çb

of columns of W P Rb¬Ñmb increases exponentially with respect to b  it is evident that computing
the ELBO in eq. (2) is typically intractable when b is large. For instance  forming and storing the
matrices involved naively require exponential time and memory. We can alleviate this concern if
j1 f piq
j  
j P R¬Ñm). If we Ô¨Ånd this structure  then we never need to explicitly compute or store a vector
where f piq
of length m. This is because eq. (2) would simply require multiple inner products between Kronecker
product vectors which the following result demonstrates can be computed extremely efÔ¨Åciently.
Proposition 1. The inner product between two Kronecker product vectors k  bb
a  bb

i1apiq can be computed as follows [18] 

i1kpiq  and

aT k 

apiq T kpiq 

(4)

1The discrete values that the ith latent variable can take  swi  may be chosen a priori or learned during ELBO
maximization (may be helpful for coarse discretizations). For the sake of simplicity  we focus on the former.

b¬πi1

3

where apiq P R¬Ñm  a P R¬Ñmb  kpiq P R¬Ñm  and k P R¬Ñmb.
This result enables substantial savings in the computation of the ELBO since each inner product

computation is reduced from the naive exponential Opsmbq cost to a linear Opbsmq cost.
if the prior is chosen to factorize between latent variables  as it often is  (i.e. Prpwq ¬±b
i1pi admits a Kronecker product structure where pi  tPrpwiswijqu

We now discuss how the Kronecker product structure of the variables in eq. (2) can be achieved. Firstly 
i1 Prpwiq)
then p  bb
¬Ñm.
The following result demonstrates how this structure for p enables log p to be written as a sum of b
Kronecker product vectors.
Proposition 2. The element-wise logarithm of the Kronecker product vector k  bb
written as a sum of b Kronecker product vectors as follows 

i1kpiq can be

¬Ñm
j1 P p0  1q

log k 

log kpiq 

(5)

b√†i1

where kpiq P R¬Ñm  k P R¬Ñmb contain positive values  and ` is a generalization of the Kronecker
sum [19] for vectors which we deÔ¨Åne as follows

log kpiq 

b√†i1

b¬∏i1 i1√¢j1

1¬Ñm
 b log kpiq b b√¢ji1

1¬Ñm
.

(6)

The proof is trivial. We will Ô¨Årst consider a mean-Ô¨Åeld variational distribution that factorizes over
i1 log qi can be written as a sum of
latent variables such that both q  bb
¬Ñm are used as the variational
parameters  Œ∏  with the use of the softmax function. For the mean-Ô¨Åeld case we can rewrite eq. (2) as

Kronecker product vectors  where qj  tPrpwjswjiqu

i1qi and log q  `b

¬Ñm
i1 P p0  1q

ELBOpŒ∏q  qT log (cid:96) 

qT

i log pi 

qT

i log qi 

(7)

b¬∏i1

b¬∏i1

where we use the fact that qi deÔ¨Ånes a valid probability distribution for the ith latent variable such
that qT
i 1¬Ñm  1. We extend results to unfactorized prior and variational distributions later in section 4.
The structure of log (cid:96) depends on the probabilistic model used; in the worst case  log (cid:96) can always
be represented as a sum of m Kronecker product vectors. However  many models admit a far more
compact structure where dramatic savings can be realized as we demonstrate in the following sections.

3.1 Generalized Linear Regression

We Ô¨Årst focus on the popular class of Bayesian generalized linear models (GLMs) for regression.
While the Bayesian integrals that arise in GLMs can be easily computed in the case of conjugate
priors  for general priors inference is challenging.
This highly general model architecture has been applied in a vast array of application areas. Recently 
Wilson et al. [20] used a scalable Bayesian generalized linear model with Gaussian priors on the
output layer of deep neural network with notable empirical success. They also considered the ability
to train the neural network simultaneously with the approximate Gaussian process which we also
have the ability to do if a practitioner were to require such an architecture.
Consider the generalized linear regression model y  Œ¶w    where   N p0  œÉ2Iq  and Œ¶ 
tœÜjpxiqui j P Rnb contains the evaluations of the basis functions on the training data. The following
result demonstrates how the ELBO can be exactly and efÔ¨Åciently computed  assuming the factorized
prior and variational distributions over w discussed earlier. Note that we also consider a prior over œÉ2.
Theorem 1. The ELBO can be exactly computed for a discretely relaxed regression GLM as follows

ELBOpŒ∏q  

n
2

qT
œÉ log œÉ2 

1

œÉ œÉ2yT y  2sTŒ¶T y  sT Œ¶T Œ¶s  diagpŒ¶T Œ¶qT s2
2qT
j hj	 
b¬∏i1qT

i log qi  qT

œÉ log pœÉ  qT

i log pi  qT

œÉ log qœÉ 

(8)

qT

b¬∏j1

4

i1 œÜ2

ijub

j1 P R¬Ñmb  and s  tqT

where qœÉ  pœÉ P R¬Ñm are factorized variational and prior distributions over the Gaussian noise
variance œÉ2 for which we consider the discrete positive values œÉ2 P R¬Ñm  respectively. Also  we use

A proof is provided in appendix A of the supplementary material. We can pre-compute the terms yT y 
Œ¶T y  H  and Œ¶T Œ¶ before training begins (since these do not depend on the variational parameters)
such that the Ô¨Ånal complexity of the proposed DIRECT method outlined in Theorem 1 is only

j¬∞n
the shorthand notation H  tsw2
Opbsm  b2q. This complexity is independent of the number of training points  making the proposed

technique ideal for massive datasets. Also  each of the pre-computed terms can easily be updated as
more data is observed making the techniques amenable to online learning applications.

j swjub

j1 P Rb.

Predictive Posterior Computations Typically  the predictive posterior distribution is found by
sampling the variational distribution at a large number of points and running the model forward for
each sample. To exactly compute the statistical moments  a model would have to be run forward at
every point in the hypothesis space with is typically intractable  however  we can exploit Kronecker
matrix algebra to efÔ¨Åciently compute these moments exactly. For example  the exact predictive
posterior mean for our generalized linear regression model is computed as follows

Epyq 

m¬∏i1

qpwiq¬ª y Prpy|wiqdy   Œ¶Wq  Œ¶s 

(9)

j swjub

j1 P Rb  and Œ¶ P R1b contains the basis functions evaluated at x. This
where s  tqT
computation is highly efÔ¨Åcient  requiring just Opbq time per test point. It can be shown that a similar
scheme can be derived to exactly compute higher order statistical moments  such as the predictive
posterior variance  for generalized linear regression models and other DIRECT models.
We have shown how to exactly compute statistical moments  and now we show how to exploit our
discrete prior to compute predictive posterior samples extremely efÔ¨Åciently. This sampling approach
may be preferable to the exact computation of statistical moments on hardware limited devices where
we need to perform inference with extreme memory  energy and computational efÔ¨Åciency. The

quantized integer array because of the discrete support of the prior which enables extremely compact
storage in memory. Much work has been done elsewhere in the machine learning community to
quantize variables for storage compression purposes since memory is a very restrictive constraint on
mobile devices [21‚Äì24]. However  we can go beyond this to additionally reduce computational and

latent variable posterior samples¬ÄW P Rbnum. samples will of course be represented as a low-precision
energy demands for the evaluation of Œ¶¬ÄW. One approach is to constrain the elements of sw to be 0

or a power of 2 so that multiplication operations simply become efÔ¨Åcient bit-shift operations [25‚Äì27].
An even more efÔ¨Åcient approach is to employ basis functions with discrete outputs so that Œ¶ can
also be represented as a low-precision quantized integer array. For example  a rounding operation
could be applied to continuous basis functions. Provided that the quantization schemes are an afÔ¨Åne
mapping of integers to real numbers (i.e. the quantized values are evenly spaced)  then inference can
be conducted using extremely efÔ¨Åcient integer arithmetic [28]. Either of these approaches enable
extremely efÔ¨Åcient on-device inference.

3.2 Deep Neural Networks for Regression

We consider the hierarchical model structure of a Bayesian deep neural network for regression.
Considering a DIRECT approach for this architecture is not conceptually challenging so long as
an appropriate neuron activation function is selected. We would like a non-linear activation that
maintains a compact representation of the log-likelihood evaluated at every point in the hypothesis
space  i.e. we would like log (cid:96) to be represented as a sum of as few Kronecker product vectors as
possible. Using a power function for the activation can maintain a compact representation; the natural
choice being a quadratic activation function (i.e. output x2 for input x).

It can be shown that the ELBO can be exactly computed in Op(cid:96)smpb{(cid:96)q4(cid:96)q for a deep Bayesian neural

network with (cid:96) layers  where we assume a quadratic activation function and an equal distribution
of discrete latent variables between network layers. This complexity evidently enables scalable
Bayesian inference for models of moderate depth  and like we found for the regression GLM model of
section 3.1  computational complexity is independent of the quantity of training data  making this ap-
proach ideal for large datasets. We outline this model and the computation of its ELBO in appendix D.

5

4 Limitations & Extensions

In generality  when the support of the prior is on a Cartesian grid  any prior  likelihood  or variational
distribution (or log-distribution) can be expressed using the proposed Kronecker matrix representation 
however  this representation will not always be compact enough to be practical. We can see this
by viewing these probability distributions over the hypothesis space as high-dimensional tensors.
In section 3  we exploited some popular models whose variational probability tensors  and whose
prior  likelihood and variational log-probability tensors all admit a low-rank structure  however  other
models may not admit this structure  in which case their representation will not be so compact. In the
interest of generalizing the technique  we outline a likelihood  a prior  and a variational distribution
that does not admit a compact representation of the ELBO and discuss several ways the DIRECT
method can still be used to efÔ¨Åciently compute  or lower bound the ELBO. We hope that these
extensions inspire future research directions in approximate Bayesian inference.

Generalized Linear Logistic Regression Logistic regression models do not easily admit a
compact representation for exact ELBO computations  however  we will demonstrate that we can
efÔ¨Åciently compute a lower-bound of the ELBO by leveraging developed algebraic techniques. To
demonstrate  we will consider a generalized linear logistic regression model which is commonly
employed for classiÔ¨Åcation problems. Such a model could easily be extended to a deep architecture
following Bradshaw et al. [2]  if desired. All terms in the ELBO in eq. (7) can be computed
exactly for this model except the term involving the log-likelihood  for which the following result
demonstrates an efÔ¨Åcient computation of the lower bound.
Theorem 2. For a generalized linear logistic regression model with classiÔ¨Åcation training labels
y P t0  1un  the class-conditional probability Prpyi0|wq  p1  exppŒ¶ri  :swqq1  and with the
assumption that training examples are sampled independently  the following inequality holds

n¬∏i1# ¬±b
¬±b

j1 qT
j1 qT

qT log (cid:96) ¬• sTŒ¶T y 
We prove this result in appendix B of the supplement. This computation can be performed in Opsmbnq

time  where dependence on n is evident unlike in the case of the exact computations described in
section 3. As a result  stochastic optimization techniques should be considered. Using this lower
bound  the log-likelihood is accurately approximated for hypotheses that correctly classify the training
data  however  hypotheses that conÔ¨Ådently misclassify training labels may be over-penalized. In
appendix B we further discuss the accuracy of this approximation and discuss a stable implementation.

j exppœÜijswjq
j exppœÜijswjq ¬∞b

i œÜijswj

if yi  0
if yi  1

j1 qT

(10)

q ¬∞r

j1 qpiq

i1 Œ±i√Çb
j  tPrpwjswjk|iqu

Unfactorized Variational Distributions We now consider going beyond a mean-Ô¨Åeld variational
distribution to account for correlations between latent variables. Considering a Ô¨Ånite mixture of
factorized categorical distributions as is used in latent structure analysis [29  30]  we can write
j   where Œ± P p0  1qr is a vector of mixture probabilities for r components 

¬Ñm.

¬Ñm
k1 P p0  1q

and qpiq
While q can evidently be expressed as a compact sum of Kronecker product vectors  log q is more
challenging to compute than in the mean-Ô¨Åeld case  however  the following result demonstrates how
we can lower-bound the term involving log q in the ELBO (eq. (7)).
Theorem 3. The following inequality holds when we consider a Ô¨Ånite mixture of factorized categorical
distributions for qŒ∏pwq 

qT log q ¬•

max

1 

taiPp0 1q ¬Ñmub

i1

r¬∏j1

Œ±j b¬∏i1

qpjq T
i

log ai  Œ±j

qpjq T
i

qpjq
i
ai

b¬πi1

 2

Œ±k

r¬∏kj1

qpjq T
i

b¬πi1

qpkq
i

ai 
 

where a  bb

i1ai  ai P p0  1q

¬Ñm is the center of the Taylor series approximation of log q.

We prove this result in appendix C and discuss a stable implementation. Note that if the mixture
variational distribution q degenerates to a mean-Ô¨Åeld distribution equal to a  then the ELBO will be
computed exactly  and as q moves away from a  the ELBO will be underestimated.

6

j1 ppiq

i1 Œ±i√Çb

distribution given by p ¬∞r

Unfactorized Prior Distributions To consider an unfactorized prior  we assume a prior mixture
j . When we use this mixture distribution for the prior  p
can evidently be expressed as a compact sum of Kronecker product vectors but log p cannot. The
following result demonstrates how we can still lower-bound the term involving log p in the ELBO
(eq. (2)). For simplicity  we assume that the variational distribution factorizes  however  the result
could easily be extended to the case of a mixture variational distribution.
Theorem 4. The following inequality holds when we consider a Ô¨Ånite mixture of factorized categorical
distributions for pŒ∏pwq 

qT log p ¬•

Œ±i

r¬∏i1

b¬∏j1

j log ppiq
qT

j

The proof is trivial by Jensen‚Äôs inequality. Note that the equality only holds when the prior mixture
degenerates to a factorized distribution with all mixture components equivalent.

Unbiased Stochastic Entropy and Prior Expectation Gradients We previously showed how to
lower bound the ELBO terms qT log p and qT log q when the variational and/or prior distributions
do not factor  however  optimizing this bound introduces bias and does not guarantee convergence to
a local optimum of the true ELBO. Here we reintroduce REINFORCE to deliver unbiased gradient
estimates for these terms. The REINFORCE estimator typically has high variance  however  since
gradient estimates for these terms are so cheap  a massive number of samples can be used per
stochastic gradient descent (SGD) iteration to decrease variance. Since we can still compute the
expensive qT log (cid:96) term exactly when q is an unfactorized mixture distribution  its gradient can be
computed exactly. The unbiased gradient estimator of qT log q is expressed as follows2

B
BŒ∏

qT log q 

1
2

 

(11)

BŒ∏ log q  12
 
qT B

B
BŒ∏

1
2t

t¬∏i1 log qpsiq  12

where si P Rb is the ith of t samples from the variational distribution used in the Monte Carlo gradient
estimator. It is evident that this surrogate loss can be easily optimized using automatic differentiation 
and the per-sample computations are extremely cheap.

5 Numerical Studies

5.1 Comparison with REINFORCE

As discussed in section 2  we cannot reparameterize because of the discrete latent variable priors
considered  however  we can directly compare the optimization performance of the proposed tech-
niques with the REINFORCE gradient estimator [11]. In Ô¨Åg. 1  we compare ELBO maximization
performance between the proposed DIRECT  and the REINFORCE methods. For this study we gen-
erated a dataset from a random weighting of b  20 random Fourier features of a squared exponential
kernel [31] and corrupted by independent Gaussian noise. We use a generalized linear regression

model as described in section 3.1 which uses the same features with sm  3. We consider a prior over
œÉ2  and a mean-Ô¨Åeld variational distribution giving smpb  1q  63 variational parameters which we

initialize to be the same as the prior; a uniform categorical distribution. For DIRECT  a L-BFGS
optimizer is used [32] and stochastic gradient descent is used for REINFORCE with a varying number
of samples used for the Monte Carlo gradient estimator. Both methods use full batch training and are
implemented using TensorFlow [33]. It can be seen that DIRECT greatly outperforms REINFORCE
both in the number of iterations and computational time. As we move to a large n or a larger b  the
difference between the proposed DIRECT technique and REINFORCE becomes more profound. The
superior scaling with respect to n was expected since we had shown in section 3.1 that the DIRECT
computational runtime is independent of n. However  the improved scaling with respect to b is an
interesting result and may be attributed to the fact that as the dimension of the variational parameter
space increases  there is more value in having low (or zero) variance estimates of the gradient.

2We used the identity  log q  1 d

B log q

BŒ∏

 1
2

B

BŒ∏ log q  12  where d denotes an elementwise product.

7

Figure 1: Convergence rates of a GLM trained with REINFORCE verses the proposed DIRECT
method. The DIRECT method greatly outperforms REINFORCE in iterations and wall-clock time.

5.2 Relaxing Gaussian Priors on UCI Regression Datasets

In this section  we consider discretely relaxing a continuous Gaussian prior on the weights of a gener-
alized linear regression model. This allows us to compare performance between a reparameterization
gradient estimator for a continuous prior and our DIRECT method for a relaxed  discrete prior.
Considering regression datasets from the UCI repository  we report the mean and standard deviation
of the root mean squared error (RMSE) from 10-fold cross validation3. Also presented is the mean
training time per fold on a machine with two E5-2680 v3 processors and 128Gb of RAM  and the
expected sparsity (percentage of zeros) within a posterior sample. All models use b  2000 basis
functions. Further details of the experimental setup can be found in appendix E. In table 1  we see
the results of our studies across several model-types. In the left column  the ‚ÄúREPARAM Mean-
Field‚Äù model uses a (continuous) Gaussian prior  an uncorrelated Gaussian variational distribution
and reparameterization gradients. The right two models use a discrete relaxation of a Gaussian
prior (DIRECT) with support at 15 discrete values  allowing storage of each latent variable sample
as a vector of 4-bit quantized integers. Therefore  each ELBO evaluation requires 152000 ¬° 102352
log-likelihood evaluations  however  these computation can be done quickly by exploiting Kronecker
matrix algebra. We compute the ELBO as described in section 3.1 for the ‚ÄúDIRECT Mean-Field‚Äù
model  and use the low-variance  unbiased gradient estimator described in eq. (11) for the ‚ÄúDIRECT
5-Mixture SGD‚Äù model which uses a mixture distribution with r  5 components  and t  3000
Monte Carlo samples for the entropy gradient estimator.
The boldface entries indicate top performance on each dataset  where it is evident that the DIRECT
method not only outperformed REPARAM on most datasets but also trained much faster  particularly
on the large datasets due to the independence of dataset size on computational complexity. The

seconds on all datasets  including electric with over 2 million points. The DIRECT mixture model

DIRECT mean-Ô¨Åeld model contains smb  30  000 variational parameters  however  training took just
contains smbr  150  000 variational parameters  and since the gradient estimates are stochastic 

average training times are on the order of hundreds of seconds across all datasets. While the time for
precomputations does depend on dataset size  its contribution to the overall timings are negligible 
being well under one second for the largest dataset  electric. Additionally  it is evident that posterior
samples from the DIRECT model tend to be very sparse. For example  the DIRECT models on the
gas dataset admit posterior samples that are over 84% sparse on average  meaning that over 1680
weights are expected to be zero in a posterior sample with b  2000 elements. This would yield
massive computational savings on hardware limited devices. Samples from the DIRECT models on
the electric dataset are over 99.6% sparse.
Comparing the DIRECT mean-Ô¨Åeld model to the mixture model  we observe gains in the RMSE
performance on many datasets  as we would expect with the increased Ô¨Çexibility of the variational
distribution. While we only showed the posterior mean in our results  we would expect an even
larger disparity in the quality of the predictive uncertainty which was not analyzed. In table 2 of
the supplement  we present results for a DIRECT mixture model that uses the ELBO lower bound
presented in Theorem 3. This model does not perform as well as the DIRECT mixture model trained
using an unbiased SGD approach  as would be expected  however  it does train faster since its

390% train  10% test per fold. We use folds from https://people.orie.cornell.edu/andrew/code

8

020406080100Iterations1301201101009080ELBO101100101102Time Elapsed (s)1301201101009080DIRECTREINFORCE 1 sampleREINFORCE 10 sampleDataset

n

d

Time RMSE

Sparsity Time RMSE

Sparsity RMSE

Sparsity

Continuous Prior

REPARAM Mean-Field

Discrete 4-bit Prior

DIRECT Mean-Field

DIRECT 5-Mixture SGD

8
4
9
8
25 5
4
5
33 5
5
7
5
6
7
5
13 5
12 5
11 5
5
9
5
8
8
5
10 5
5
5
11 5
128 5
19 46
26 47
20 48
26 50
18 51
9
58
20 58
385 61
27 61

challenger 23
fertility
100
automobile 159
servo
167
194
cancer
209
hardware
308
yacht
392
autompg
506
housing
forest
517
stock
536
pendulum 630
768
energy
1030
concrete
1066
solar
1503
airfoil
wine
1599
2565
gas
3338
skillcraft
sml
4137
parkinsons 5875
15000
poletele
elevators
16599
45730
protein
48827
kegg
53500
ctslice
63608
keggu
434874 3
3droad
song
515345 90 158 0.537  0.002
583250 77 169 0.94  0.006
buzz
electric
2049280 11 500 9.26  4.47

0.515  0.284 0%
0%
0.161  0.043
0%
0.425  0.2
0%
0.524  0.184
0%
27.488  5.45
0%
1.796  1.537
0%
0.815  0.17
0%
4.05  0.739
0%
3.014  0.567
0%
1.378  0.148
0%
0.751  0.338
0%
1.465  0.26
78.852  21.73 0%
10.347  2.847 0%
0%
0.902  0.171
2.071  0.271 0%
0%
0.939  0.33
0%
0.27  0.052
0%
0.273  0.029
0.327  0.013 0%
0.158  0.009 0%
12.487  0.363 0%
0%
0.247  0.156
0%
0.642  0.006
0.178  0.012 0%
4.415  0.113 0%
0.122  0.004 0%
141 11.057  0.091 0%
0%
0%
0%

1
2
10
10
4
11
1
10
10
2
8
1
1
10
10
11
11
1
7
1
1
10
1
11
1
2
1
2
2
1
1

0.523  0.248 17%
0.159  0.041 17%
0.129  0.063 51%
0.271  0.08 35%
22.954  3.09 19%
0.401  0.048 51%
96%
0.234  0.07
2.564  0.363 31%
2.752  0.405 40%
17%
1.363  0.15
0.011  0.003 98%
1.329  0.282 68%
3.272  0.332 99%
5.316  0.716 82%
0.787  0.192 23%
2.175  0.349 48%
0.472  0.044 54%
0.211  0.058 84%
0.253  0.016 97%
0.677  0.044 57%
0.651  0.034 13%
13.65  0.348 16%
0.124  0.003 99%
0.619  0.007 76%
0.222  0.009 96%
6.063  0.122 19%
0.139  0.004 87%
10.493  0.105 40%
0.501  0.002 32%
1.007  0.007 82%
0.575  0.032 99.6% 0.557  0.055 99.6%

17%
0.525  0.246
17%
0.16  0.041
0.122  0.056 51%
35%
0.274  0.077
22.937  3.135 19%
0.401  0.046 51%
0.225  0.082 96%
2.543  0.362 31%
2.699  0.361 39%
1.357  0.155 17%
0.008  0.001 98%
1.312  0.253 63%
2.911  0.309 99%
82%
5.477  0.632
23%
0.788  0.189
45%
2.156  0.316
0.469  0.042 54%
0.184  0.063 76%
0.253  0.016 97%
57%
0.671  0.047
13%
0.613  0.083
13.369  0.431 17%
0.124  0.003 99%
0.618  0.007 60%
95%
0.205  0.004
42%
5.478  0.137
87%
0.136  0.006
10.354  0.077 33%
0.498  0.002 28%
80%
0.959  0.004

Table 1: Mean and standard deviation of test error  average training time  and average expected
sparsity of a posterior sample from 10-fold cross validation on UCI regression datasets.

objective is evaluated deterministically  and its RMSE performance is still marginally better than the
DIRECT mean-Ô¨Åeld model on many datasets.

6 Conclusions

We have shown that by discretely relaxing continuous priors  variational inference can be performed
accurately and efÔ¨Åciently using our DIRECT method. We have demonstrated that through the
use of Kronecker matrix algebra  the ELBO of a discretely relaxed model can be efÔ¨Åciently and
exactly computed even when this computation requires signiÔ¨Åcantly more log-likelihood evaluations
than the number of atoms in the known universe. Through this ability to exactly perform ELBO
computations we achieve unbiased  zero-variance gradient estimates using automatic differentiation
which we show signiÔ¨Åcantly outperforms competing Monte Carlo alternatives that admit high-variance
gradient estimates. We also demonstrate that the computational complexity of ELBO computations
is independent of the quantity of training data using the DIRECT method  making the proposed
approaches amenable to big data applications. At inference time  we show that we can again use
Kronecker matrix algebra to exactly compute the statistical moments of the parameterized predictive
posterior distribution  unlike competing techniques which rely on Monte Carlo sampling. Finally  we
discuss and demonstrate how posterior samples can be sparse and can be represented as quantized
integer values to enable efÔ¨Åcient inference which is particularly powerful on hardware limited devices 
or if energy efÔ¨Åciency is a major concern.
We illustrate the DIRECT approach on several popular models such as mean-Ô¨Åeld variational inference
for generalized linear models and deep Bayesian neural networks for regression. We also discuss
some models which do not admit a compact representation for exact ELBO computations. For these
cases  we discuss and demonstrate novel extensions to the DIRECT method that allow efÔ¨Åcient
computation of a lower bound of the ELBO  and we demonstrate how an unfactorized variational
distribution can be used by introducing a manageable level of stochasticity into the gradients. We
hope that these new approaches for ELBO computations will inspire new model structures and
research directions in approximate Bayesian inference.

9

Acknowledgements

Research funded by an NSERC Discovery Grant and the Canada Research Chairs program.

References
[1] S. Thrun  W. Burgard  and D. Fox. Probabilistic robotics. MIT press  2005.
[2]

J. Bradshaw  A. G. d. G. Matthews  and Z. Ghahramani. Adversarial Examples  Uncertainty 
and Transfer Testing Robustness in Gaussian Process Hybrid Deep Networks. Tech. rep. 2017.
[3] C. Louizos  K. Ullrich  and M. Welling. ‚ÄúBayesian compression for deep learning‚Äù. In: Ad-

vances in Neural Information Processing Systems. 2017  pp. 3288‚Äì3298.

[4] M. I. Jordan  Z. Ghahramani  T. S. Jaakkola  and L. K. Saul. ‚ÄúAn introduction to variational

methods for graphical models‚Äù. In: Machine learning 37.2 (1999)  pp. 183‚Äì233.

[5] M. J. Wainwright and M. I. Jordan. ‚ÄúGraphical models  exponential families  and variational

inference‚Äù. In: Foundations and Trends in Machine Learning 1.1‚Äì2 (2008)  pp. 1‚Äì305.

[6] M. D. Hoffman  D. M. Blei  C. Wang  and J. Paisley. ‚ÄúStochastic variational inference‚Äù. In:

The Journal of Machine Learning Research 14.1 (2013)  pp. 1303‚Äì1347.

[7] R. Ranganath  S. Gerrish  and D. Blei. ‚ÄúBlack box variational inference‚Äù. In: ArtiÔ¨Åcial Intelli-

gence and Statistics. 2014  pp. 814‚Äì822.

[8] A. Kucukelbir  D. Tran  R. Ranganath  A. Gelman  and D. M. Blei. ‚ÄúAutomatic differentiation
variational inference‚Äù. In: The Journal of Machine Learning Research 18.1 (2017)  pp. 430‚Äì
474.

[9] D. M. Blei  A. Kucukelbir  and J. D. McAuliffe. ‚ÄúVariational inference: A review for statisti-

cians‚Äù. In: Journal of the American Statistical Association 112.518 (2017)  pp. 859‚Äì877.

[10] D. P. Kingma and M. Welling. ‚ÄúAuto-encoding variational Bayes‚Äù. In: arXiv preprint

arXiv:1312.6114 (2013).

[11] R. J. Williams. ‚ÄúSimple statistical gradient-following algorithms for connectionist reinforce-

ment learning‚Äù. In: Reinforcement Learning. 1992  pp. 5‚Äì32.

[12] M. C. Fu. ‚ÄúGradient estimation‚Äù. In: Handbooks in operations research and management

science 13 (2006)  pp. 575‚Äì616.

[13] P. W. Glynn. ‚ÄúLikelihood ratio gradient estimation for stochastic systems‚Äù. In: Communications

of the ACM 33.10 (1990)  pp. 75‚Äì84.

[14] E. Jang  S. Gu  and B. Poole. ‚ÄúCategorical reparameterization with Gumbel-softmax‚Äù. In:

arXiv preprint arXiv:1611.01144 (2016).

[15] C. J. Maddison  A. Mnih  and Y. W. Teh. ‚ÄúThe concrete distribution: A continuous relaxation

of discrete random variables‚Äù. In: arXiv preprint arXiv:1611.00712 (2016).

[16] G. Tucker  A. Mnih  C. J. Maddison  J. Lawson  and J. Sohl-Dickstein. ‚ÄúREBAR: Low-
variance  unbiased gradient estimates for discrete latent variable models‚Äù. In: Advances in
Neural Information Processing Systems. 2017  pp. 2627‚Äì2636.

[17] W. Grathwohl  D. Choi  Y. Wu  G. Roeder  and D. Duvenaud. ‚ÄúBackpropagation through
the void: Optimizing control variates for black-box gradient estimation‚Äù. In: International
Conference on Learning Representations. 2017.

[18] C. F. Van Loan. ‚ÄúThe ubiquitous Kronecker product‚Äù. In: Journal of Computational and

Applied Mathematics 123.1 (2000)  pp. 85‚Äì100.

[19] R. A. Horn and C. R. Johnson. Topics in Matrix analysis. Cambridge university press  1994 

p. 208.

[20] A. G. Wilson  Z. Hu  R. Salakhutdinov  and E. P. Xing. ‚ÄúDeep kernel learning‚Äù. In: ArtiÔ¨Åcial

Intelligence and Statistics. 2016  pp. 370‚Äì378.

[21] W. Chen  J. Wilson  S. Tyree  K. Weinberger  and Y. Chen. ‚ÄúCompressing neural networks with
the hashing trick‚Äù. In: International Conference on Machine Learning. 2015  pp. 2285‚Äì2294.
[22] Y. Gong  L. Liu  M. Yang  and L. Bourdev. ‚ÄúCompressing deep convolutional networks using

vector quantization‚Äù. In: arXiv preprint arXiv:1412.6115 (2014).

[23] S. Han  H. Mao  and W. J. Dally. ‚ÄúDeep compression: Compressing deep neural networks
with pruning  trained quantization and huffman coding‚Äù. In: arXiv preprint arXiv:1510.00149
(2015).

10

[24] A. Zhou  A. Yao  Y. Guo  L. Xu  and Y. Chen. ‚ÄúIncremental network quantization: Towards

lossless cnns with low-precision weights‚Äù. In: arXiv preprint arXiv:1702.03044 (2017).
I. Hubara  M. Courbariaux  D. Soudry  R. El-Yaniv  and Y. Bengio. ‚ÄúBinarized neural net-
works‚Äù. In: Advances in neural information processing systems. 2016  pp. 4107‚Äì4115.

[25]

[26] F. Li  B. Zhang  and B. Liu. ‚ÄúTernary weight networks‚Äù. In: arXiv preprint arXiv:1605.04711

(2016).

[27] M. Rastegari  V. Ordonez  J. Redmon  and A. Farhadi. ‚ÄúXnor-net: Imagenet classiÔ¨Åcation
using binary convolutional neural networks‚Äù. In: European Conference on Computer Vision.
Springer. 2016  pp. 525‚Äì542.

[28] B. Jacob  S. Kligys  B. Chen  M. Zhu  M. Tang  A. Howard  H. Adam  and D. Kalenichenko.
‚ÄúQuantization and Training of Neural Networks for EfÔ¨Åcient Integer-Arithmetic-Only Infer-
ence‚Äù. In: arXiv preprint arXiv:1712.05877 (2017).

[29] P. Lazarsfeld and N. Henry. Latent structure analysis. Houghton MifÔ¨Çin Company  Boston 

Massachusetts  1968.

[30] L. A. Goodman. ‚ÄúExploratory latent structure analysis using both identiÔ¨Åable and unidentiÔ¨Åable

models‚Äù. In: Biometrika 61.2 (1974)  pp. 215‚Äì231.

[31] A. Rahimi and B. Recht. ‚ÄúRandom features for large-scale kernel machines‚Äù. In: Advances in

Neural Information Processing Systems. 2007  pp. 1177‚Äì1184.

[32] R. H. Byrd  P. Lu  J. Nocedal  and C. Zhu. ‚ÄúA limited memory algorithm for bound constrained

optimization‚Äù. In: SIAM Journal on ScientiÔ¨Åc Computing 16.5 (1995)  pp. 1190‚Äì1208.

[33] M. Abadi et al. ‚ÄúTensorFlow: A System for Large-Scale Machine Learning.‚Äù In: OSDI. Vol. 16.

2016  pp. 265‚Äì283.

[34] C. M. Bishop. Pattern Recognition and Machine Learning. Springer  2006.
[35] F. Nielsen and K. Sun. ‚ÄúGuaranteed bounds on the Kullback-Leibler divergence of univariate

mixtures using piecewise log-sum-exp inequalities‚Äù. In: arXiv:1606.05850 (2016).

[36] C. E. Rasmussen and C. K. I. Williams. Gaussian Processes for Machine Learning. MIT Press 

2006.

[37] D. Tran  A. Kucukelbir  A. B. Dieng  M. Rudolph  D. Liang  and D. M. Blei. ‚ÄúEdward: A library
for probabilistic modeling  inference  and criticism‚Äù. In: arXiv preprint arXiv:1610.09787
(2016).

11

,Trefor Evans
Prasanth Nair